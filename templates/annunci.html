{% extends "base.html" %}
{% block title %}Dashboard — Profili{% endblock %}
{% block content %}

<div class="posts-wrapper">

  <!-- =========================================================================
       BARRA AZIONI ADMIN (solo autenticati)
       ========================================================================= -->
  {% if current_user.is_authenticated %}
    <div class="d-flex bg-light border-bottom justify-content-center align-items-center py-2">
      <div class="d-flex flex-wrap justify-content-center gap-2">
        <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#site-modal-profile">Inserisci profilo</button>
      </div>
    </div>
  {% endif %}

  <!-- =========================================================================
       INTRO PUBBLICA (solo non autenticati)
       ========================================================================= -->
  <div class="container my-3 px-4">
  {% if not current_user.is_authenticated %}
    <div class="p-4 mb-4 bg-light rounded shadow-sm text-center">
      <h2 class="text-primary fw-bold mb-3">Come funziona</h2>
      <div class="d-flex flex-column flex-md-row justify-content-center align-items-center gap-4">
        <div class="d-flex flex-column align-items-center">
          <i class="bi bi-journal-text fs-1 text-primary"></i>
          <p class="mt-2 fw-semibold">1. Leggi gli annunci scorrendo verso il basso</p>
        </div>
        <div class="d-flex flex-column align-items-center">
          <i class="bi bi-chat-dots fs-1 text-primary"></i>
          <p class="mt-2 fw-semibold">2. Scrivi alla persona giusta per te</p>
        </div>
        <div class="d-flex flex-column align-items-center">
          <i class="bi bi-envelope-heart fs-1 text-primary"></i>
          <p class="mt-2 fw-semibold">3. Aspetta di essere ricontattato</p>
        </div>
      </div>
    </div>
  {% endif %}

    <!-- =======================================================================
         FILTRI DI RICERCA (lasciati invariati)
         ======================================================================= -->
    <div class="p-3 mb-4 bg-light rounded shadow-sm">
      <h5 class="text-primary fw-bold mb-3">Inserisci le tue preferenze <small class="text-muted">(opzionale)</small></h5>
      <form method="GET" action="{{ url_for('annunci') }}#first-result">
        <div class="row g-3">
          <div class="col-12">
            <label class="form-label small text-primary fw-bold">Cerco</label>
            <div class="d-flex gap-3">
              <div class="form-check">
                <input class="form-check-input" type="radio" name="gender" id="cercoUomo" value="male"
                       {% if request.args.get('gender','')|lower == 'male' %}checked{% endif %}>
                <label class="form-check-label" for="cercoUomo"><i class="bi bi-gender-male text-primary me-1"></i> Uomo</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="gender" id="cercoDonna" value="female"
                       {% if request.args.get('gender','')|lower == 'female' %}checked{% endif %}>
                <label class="form-check-label" for="cercoDonna"><i class="bi bi-gender-female text-danger me-1"></i> Donna</label>
              </div>
            </div>
          </div>

          <div class="col-md-4">
            <label class="form-label small text-primary fw-bold">Fascia d’età</label>
            {% set sel_age = request.args.get('age_range','') %}
            <select class="form-select" name="age_range">
              <option value=""        {% if sel_age == '' %}selected{% endif %}>Qualsiasi</option>
              <option value="25-35"   {% if sel_age == '25-35' %}selected{% endif %}>25 - 35</option>
              <option value="35-45"   {% if sel_age == '35-45' %}selected{% endif %}>35 - 45</option>
              <option value="45-55"   {% if sel_age == '45-55' %}selected{% endif %}>45 - 55</option>
              <option value="55+"     {% if sel_age == '55+' %}selected{% endif %}>Oltre 55</option>
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label small text-primary fw-bold">Colore capelli</label>
            {% set sel_hair = request.args.get('hair_color','')|lower %}
            <select class="form-select" name="hair_color">
              <option value=""         {% if sel_hair == '' %}selected{% endif %}>Qualsiasi</option>
              <option value="biondi"   {% if sel_hair == 'biondi' %}selected{% endif %}>Biondi</option>
              <option value="castani"  {% if sel_hair == 'castani' %}selected{% endif %}>Castani</option>
              <option value="neri"     {% if sel_hair == 'neri' %}selected{% endif %}>Neri</option>
              <option value="rossi"    {% if sel_hair == 'rossi' %}selected{% endif %}>Rossi</option>
              <option value="grigi"    {% if sel_hair == 'grigi' %}selected{% endif %}>Grigi</option>
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label small text-primary fw-bold">Colore occhi</label>
            {% set sel_eyes = request.args.get('eyes_color','')|lower %}
            <select class="form-select" name="eyes_color">
              <option value=""          {% if sel_eyes == '' %}selected{% endif %}>Qualsiasi</option>
              <option value="castani"   {% if sel_eyes == 'castani' %}selected{% endif %}>Castani</option>
              <option value="azzurri"   {% if sel_eyes == 'azzurri' %}selected{% endif %}>Azzurri</option>
              <option value="verdi"     {% if sel_eyes == 'verdi' %}selected{% endif %}>Verdi</option>
              <option value="grigi"     {% if sel_eyes == 'grigi' %}selected{% endif %}>Grigi</option>
              <option value="nocciola"  {% if sel_eyes == 'nocciola' %}selected{% endif %}>Nocciola</option>
            </select>
          </div>

          {% if current_user.is_authenticated %}
            <div class="col-md-4">
              <label class="form-label small text-primary fw-bold">Nome</label>
              <input type="text" class="form-control" name="name"
                     value="{{ request.args.get('name','') }}"
                     placeholder="es. Carlo">
            </div>

            <div class="col-md-4">
              <label class="form-label small text-primary fw-bold">ID profilo</label>
              <input type="number" class="form-control"
                name="id" min="1" step="1" inputmode="numeric" pattern="\d*"
                value="{{ request.args.get('id','') }}" placeholder="es. 123">
            </div>
          {% endif %}

          <div class="col-12 text-center">
            <button type="submit" class="btn btn-primary px-4">Filtra</button>
            <a href="{{ url_for('annunci') }}#first-result" class="btn btn-outline-secondary ms-2">Reset</a>
          </div>
        </div>
      </form>
    </div>

    <!-- =======================================================================
         RIEPILOGO FILTRI + CONTEGGIO
         ======================================================================= -->
    {% set n = listObjProfiles|length %}
    <div class="d-flex align-items-center mb-3 gap-2
                flex-column-reverse flex-md-row
                justify-content-center justify-content-md-between">
      <div class="fw-semibold mt-2 mt-md-0 text-center text-md-start w-100 w-md-auto">
        {{ n }} profil{{ 'o' if n==1 else 'i' }}
      </div>

      <div class="d-flex flex-wrap gap-2
                  justify-content-center justify-content-md-end w-100 w-md-auto">
        {% if current_user.is_authenticated and request.args.get('filter_id') %}
          <span class="badge bg-info text-dark">ID: #{{ request.args.get('id') }}</span>
        {% endif %}
        {% if request.args.get('gender') %}
          <span class="badge bg-primary">Cerco: {{ 'Uomo' if request.args.get('gender')=='male' else 'Donna' }}</span>
        {% endif %}
        {% if current_user.is_authenticated and request.args.get('name') %}
          <span class="badge bg-secondary">Nome: {{ request.args.get('name') }}</span>
        {% endif %}
        {% if request.args.get('age_range') %}
          <span class="badge bg-secondary">Età: {{ request.args.get('age_range') }}</span>
        {% endif %}
        {% if request.args.get('hair_color') %}
          <span class="badge bg-secondary">Capelli: {{ request.args.get('hair_color') }}</span>
        {% endif %}
        {% if request.args.get('eyes_color') %}
          <span class="badge bg-secondary">Occhi: {{ request.args.get('eyes_color') }}</span>
        {% endif %}
      </div>
    </div>

    <!-- =======================================================================
         LISTA PROFILI
         ======================================================================= -->
    {% if listObjProfiles %}
      <div class="row g-4" >
        {% for p in listObjProfiles %}
          {% set eta = (current_year - p['birth_year']) if p['birth_year'] else None %}
          {% set fuma = (p['smoker'] in [1, '1', true, 'true', 'on']) if p['smoker'] is not none else None %}
          {% set stato = (p['marital_status'] or '') %}
          {% if stato %}
            {% if stato|lower in ['celibe/nubile','single'] %}
              {% set stato_it = 'nubile' if p['gender'] == 'female' else 'celibe' %}
            {% elif stato|lower in ['sposato/a','married'] %}
              {% set stato_it = 'sposata' if p['gender'] == 'female' else 'sposato' %}
            {% elif stato|lower in ['separato/a','separated'] %}
              {% set stato_it = 'separata' if p['gender'] == 'female' else 'separato' %}
            {% elif stato|lower in ['divorziato/a','divorced'] %}
              {% set stato_it = 'divorziata' if p['gender'] == 'female' else 'divorziato' %}
            {% elif stato|lower in ['vedovo/a','widowed'] %}
              {% set stato_it = 'vedova' if p['gender'] == 'female' else 'vedovo' %}
            {% else %}
              {% set stato_it = stato %}
            {% endif %}
          {% else %}
            {% set stato_it = '' %}
          {% endif %}
         {% set parts = [] %}

          {# Età #}
          {% if eta %}{% set _ = parts.append(eta ~ ' anni') %}{% endif %}

          {# Professione #}
          {% if p['occupation'] %}{% set _ = parts.append(p['occupation']) %}{% endif %}

          {# Capelli e occhi #}
          {% if p['hair_color'] %}{% set _ = parts.append('capelli ' ~ p['hair_color']) %}{% endif %}
          {% if p['eyes_color'] %}{% set _ = parts.append('occhi ' ~ p['eyes_color']) %}{% endif %}

          {# Altezza e peso #}
          {% if p['height_cm'] %}
            {% set h_m = p['height_cm'] / 100.0 %}
            {% set _ = parts.append(('%.2f'|format(h_m)) ~ ' m') %}
          {% endif %}
          {% if p['weight_kg'] %}{% set _ = parts.append(p['weight_kg'] ~ ' kg') %}{% endif %}

          {# Stato civile #}
          {% if stato_it %}{% set _ = parts.append(stato_it) %}{% endif %}

          {# Fumo con genere #}
          {% if fuma is not none %}
            {% if p['gender'] == 'female' %}
              {% set _ = parts.append('fumatrice' if fuma else 'non fumatrice') %}
            {% else %}
              {% set _ = parts.append('fumatore' if fuma else 'non fumatore') %}
            {% endif %}
          {% endif %}

          <div class="col-12 col-sm-6 col-lg-4" {% if loop.first %}id="first-result"{% endif %}>
            <div class="card h-100 shadow-sm border-0">
              <div class="card-body d-flex flex-column">

                <div class="profile-header">
                  <div class="profile-name">
                    {% if current_user.is_authenticated %}
                      {{ (p['first_name'] ~ ' ' ~ (p['last_name'] or ''))|trim|upper }}
                    {% else %}
                      {{ p['first_name']|upper }}
                    {% endif %}
                  </div>

                  {% if current_user.is_authenticated and p['id'] %}
                    <span class="badge rounded-pill bg-info text-dark">ID #{{ p['id'] }}</span>
                  {% endif %}
                </div>

                {# ===== DETTAGLI IN UN’UNICA RIGA, MAIUSCOLO ===== #}
                <div class="text-uppercase text-secondary small profile-meta mb-2">
                  {{ parts|join(', ')|upper }}
                </div>

                {# ===== BIO: 5 righe + "continua a leggere" ===== #}
                {% set bio_text = (p['bio'] or '') %}
                <div class="bio-block flex-grow-1" data-lines="5">
                  <div class="small bio-textbox">
                    <div class="bio-text">{{ (p['bio'] or '') | e }}</div>
                  </div>

                  <div class="read-more-line d-none">
                    <span class="dots">...</span>
                    <button type="button" class="read-more" aria-expanded="false">Continua a leggere</button>
                  </div>
                </div>

                <div class="d-flex justify-content-between align-items-center mt-2 gap-2">
                  {% if not current_user.is_authenticated %}
                    <a href="#" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#replyModal-{{ p['id'] }}">
                      <i class="bi bi-heart"></i><span class="ms-1">Scrivi a {{ p['first_name'] }}</span>
                    </a>
                  {% endif %}

                  {% if current_user.is_authenticated %}
                    <div class="d-flex gap-2">
                      <a href="{{ url_for('annunci', profile_id=p['id']) }}" class="btn btn-outline-secondary btn-sm" title="Modifica">
                        <i class="bi bi-pencil"></i>
                      </a>
                      <form action="{{ url_for('create_or_update_profile') }}" method="POST" style="display:inline;">
                        <input type="hidden" name="profile_id" value="{{ p['id'] | e }}">
                        <button type="submit" name="action" value="delete" class="btn btn-outline-danger btn-sm"
                                onclick="return confirm('Eliminare questo profilo?');" title="Elimina">
                          <i class="bi bi-trash"></i>
                        </button>
                      </form>
                    </div>
                  {% endif %}
                </div>

              </div>
            </div>
          </div>

          {# =====================================================================
             MODAL: SCRIVI AL PROFILO
             ===================================================================== #}
          <div class="modal fade" id="replyModal-{{ p['id'] }}" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Scrivi a {{ p['first_name'] }}</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
                </div>
                <div class="modal-body">
                  <p class="mb-3">Compila i campi sottostanti:</p>
                  <form action="{{ url_for('send_message') }}" method="POST" class="needs-validation" novalidate>
                    <input type="hidden" name="profile_id" value="{{ p['id'] }}">
                    <input type="hidden" name="profile_name" value="{{ p['first_name'] }} {{ p['last_name'] or '' }}">

                    <div class="row g-3">
                      <div class="col-md-6">
                        <label class="form-label small" for="sender_name_{{ p['id'] }}">Nome *</label>
                        <input type="text" class="form-control" id="sender_name_{{ p['id'] }}" name="sender_name" required>
                        <div class="invalid-feedback">Per favore inserisci il tuo nome.</div>
                      </div>

                      <div class="col-md-6">
                        <label class="form-label small" for="sender_phone_{{ p['id'] }}">Cellulare *</label>
                        <input type="tel" class="form-control" id="sender_phone_{{ p['id'] }}" name="sender_phone" required>
                        <div class="invalid-feedback">Inserisci un numero di cellulare.</div>
                      </div>

                      <div class="col-md-6">
                        <label class="form-label small" for="sender_email_{{ p['id'] }}">Email *</label>
                        <input type="email" class="form-control" id="sender_email_{{ p['id'] }}" name="sender_email" required>
                        <div class="invalid-feedback">Inserisci un’email valida.</div>
                      </div>

                      <div class="col-md-6">
                        <label class="form-label small" for="sender_job_{{ p['id'] }}">Lavoro (facoltativo)</label>
                        <input type="text" class="form-control" id="sender_job_{{ p['id'] }}" name="sender_job">
                      </div>

                      <div class="col-md-4">
                        <label class="form-label small" for="sender_age_{{ p['id'] }}">Età *</label>
                        <input type="number" min="18" max="120" class="form-control" id="sender_age_{{ p['id'] }}" name="sender_age" required>
                        <div class="invalid-feedback">Inserisci la tua età (18–120).</div>
                      </div>

                      <div class="col-md-8">
                        <label class="form-label small" for="sender_city_{{ p['id'] }}">Città *</label>
                        <input type="text" class="form-control" id="sender_city_{{ p['id'] }}" name="sender_city" required>
                        <div class="invalid-feedback">Inserisci la tua città.</div>
                      </div>

                      <div class="col-12">
                        <label class="form-label small" for="sender_message_{{ p['id'] }}">Un tuo commento libero</label>
                        <textarea class="form-control" rows="4" id="sender_message_{{ p['id'] }}" name="sender_message"></textarea>
                      </div>
                    </div>

                   <div class="form-check mt-3">
                    <input class="form-check-input" type="checkbox" id="privacy_{{ p['id'] }}" name="agree_privacy" required>
                    <label class="form-check-label small" for="privacy_{{ p['id'] }}">
                      Ho accettato l’<a href="https://www.iubenda.com/privacy-policy/7777397" 
                                        target="_blank" 
                                        rel="noopener noreferrer" 
                                        class="text-primary custom-a">
                        informativa sul trattamento dei dati personali
                      </a>
                    </label>
                    <div class="invalid-feedback">Devi accettare l’informativa privacy.</div>
                  </div>


                    <div class="modal-footer mt-4">
                      <button type="submit" class="btn btn-primary">Contatta</button>
                      <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Torna indietro</button>
                    </div>
                  </form>

                </div>
              </div>
            </div>
          </div>

        {% endfor %}
      </div>
    {% endif %}
  </div> {# /container #}

  <!-- =========================================================================
       MODAL CREAZIONE/MODIFICA PROFILO (solo autenticati)
       ========================================================================= -->
  {% if current_user.is_authenticated %}
  <div class="modal fade" id="site-modal-profile" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5">{{ 'Modifica profilo' if profile_to_edit else 'Crea profilo' }}</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
        </div>
        <div class="modal-body">
          <form action="{{ url_for('create_or_update_profile') }}" method="POST">
            <input type="hidden" name="profile_id" value="{{ (profile_to_edit.id if profile_to_edit else '') | e }}">

            <div class="row g-2">
              <div class="col-md-6">
                <label class="form-label small">Nome *</label>
                <input type="text" class="form-control" name="first_name" required
                       value="{{ (profile_to_edit.first_name if profile_to_edit else '') | e }}">
              </div>
              <div class="col-md-6">
                <label class="form-label small">Cognome</label>
                <input type="text" class="form-control" name="last_name"
                       value="{{ (profile_to_edit.last_name if profile_to_edit else '') | e }}">
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-md-6">
                <label class="form-label small">Genere *</label>
                {% set gsel = (profile_to_edit.gender if profile_to_edit else '') %}
                <select class="form-select" name="gender" required>
                  <option value="" {% if not gsel %}selected{% endif %}>Seleziona...</option>
                  <option value="female" {% if gsel == 'female' %}selected{% endif %}>Donna</option>
                  <option value="male" {% if gsel == 'male' %}selected{% endif %}>Uomo</option>
                  <option value="other" {% if gsel == 'other' %}selected{% endif %}>Altro</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label small">Anno di nascita</label>
                <input type="number" class="form-control" name="birth_year" min="1900" max="2100"
                       value="{{ (profile_to_edit.birth_year if profile_to_edit else '') | e }}">
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-md-6">
                <label class="form-label small">Città</label>
                <input type="text" class="form-control" name="city"
                       value="{{ (profile_to_edit.city if profile_to_edit else '') | e }}">
              </div>
              <div class="col-md-6">
                <label class="form-label small">Occupazione</label>
                <input type="text" class="form-control" name="occupation"
                       value="{{ (profile_to_edit.occupation if profile_to_edit else '') | e }}">
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-md-4">
                <label class="form-label small">Colore occhi</label>
                {% set esel = (profile_to_edit.eyes_color if profile_to_edit else '') %}
                <select class="form-select" name="eyes_color">
                  <option value="" {% if not esel %}selected{% endif %}>Seleziona...</option>
                  <option value="Azzurri"  {% if esel == 'Azzurri' %}selected{% endif %}>Azzurri</option>
                  <option value="Verdi"    {% if esel == 'Verdi' %}selected{% endif %}>Verdi</option>
                  <option value="Marroni"  {% if esel == 'Marroni' %}selected{% endif %}>Marroni</option>
                  <option value="Neri"     {% if esel == 'Neri' %}selected{% endif %}>Neri</option>
                  <option value="Grigi"    {% if esel == 'Grigi' %}selected{% endif %}>Grigi</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label small">Colore capelli</label>
                {% set hsel = (profile_to_edit.hair_color if profile_to_edit else '') %}
                <select class="form-select" name="hair_color">
                  <option value="" {% if not hsel %}selected{% endif %}>Seleziona...</option>
                  <option value="Biondi"   {% if hsel == 'Biondi' %}selected{% endif %}>Biondi</option>
                  <option value="Castani"  {% if hsel == 'Castani' %}selected{% endif %}>Castani</option>
                  <option value="Neri"     {% if hsel == 'Neri' %}selected{% endif %}>Neri</option>
                  <option value="Rossi"    {% if hsel == 'Rossi' %}selected{% endif %}>Rossi</option>
                  <option value="Grigi"    {% if hsel == 'Grigi' %}selected{% endif %}>Grigi</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label small">Altezza (m)</label>
                <input
                type="number"
                class="form-control"
                name="height_m"
                min="1.00" max="2.50" step="0.01" inputmode="decimal"
                value="{{ ('%.2f'|format((profile_to_edit.height_cm|float) / 100.0)) if (profile_to_edit and profile_to_edit.height_cm) else '' }}">
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-md-4">
                <label class="form-label small">Peso (kg)</label>
                <input type="number" class="form-control" name="weight_kg" min="30" max="300" step="1"
                       value="{{ (profile_to_edit.weight_kg if profile_to_edit else '') | e }}">
              </div>
              <div class="col-md-4">
                <label class="form-label small">Stato civile</label>
                {% set msel = (profile_to_edit.marital_status if profile_to_edit else '') %}
                <select class="form-select" name="marital_status">
                  <option value="" {% if not msel %}selected{% endif %}>Seleziona...</option>
                  <option value="Celibe/Nubile" {% if msel == 'Celibe/Nubile' %}selected{% endif %}>Celibe/Nubile</option>
                  <option value="Sposato/a"     {% if msel == 'Sposato/a' %}selected{% endif %}>Sposato/a</option>
                  <option value="Separato/a"    {% if msel == 'Separato/a' %}selected{% endif %}>Separato/a</option>
                  <option value="Divorziato/a"  {% if msel == 'Divorziato/a' %}selected{% endif %}>Divorziato/a</option>
                  <option value="Vedovo/a"      {% if msel == 'Vedovo/a' %}selected{% endif %}>Vedovo/a</option>
                </select>
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-md-4">
                <div class="form-check mt-4">
                  <input class="form-check-input" type="checkbox" name="smoker" id="smoker"
                         {% if profile_to_edit and profile_to_edit.smoker %}checked{% endif %}>
                  <label class="form-check-label small" for="smoker">Fumatore</label>
                </div>
              </div>
            </div>

            <div class="mt-3">
              <label class="form-label small">Bio *</label>
              <textarea class="form-control" name="bio" rows="4" required>{{ profile_to_edit.bio if profile_to_edit else '' }}</textarea>
            </div>

            <div class="modal-footer mt-3 px-0">
              {% if profile_to_edit %}
                <button name="action" value="update" type="submit" class="btn btn-primary btn-sm">Aggiorna</button>
                <button name="action" value="delete" type="submit" class="btn btn-outline-danger btn-sm"
                        onclick="return confirm('Eliminare questo profilo?');">Elimina</button>
              {% else %}
                <button type="submit" class="btn btn-primary btn-sm">Salva profilo</button>
              {% endif %}
              <button type="button" class="btn btn-outline-primary btn-sm" data-bs-dismiss="modal">Annulla</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- =========================================================================
       SCRIPT APERTURA MODALE MODIFICA PROFILO
       ========================================================================= -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const modalEl = document.getElementById('site-modal-profile');
      if (!modalEl) return;
      const form = modalEl.querySelector('form');

      function resetProfileFormToCreate() {
        if (!form) return;

        // id vuoto = modalità "create"
        const hid = form.querySelector('[name="profile_id"]');
        if (hid) hid.value = '';

        // input text/number/textarea -> vuoti
        ['first_name','last_name','city','occupation','birth_year','height_m','weight_kg','bio']
          .forEach(n => { const el = form.querySelector(`[name="${n}"]`); if (el) el.value = ''; });

        // select -> prima opzione (placeholder)
        ['gender','eyes_color','hair_color','marital_status']
          .forEach(n => { const el = form.querySelector(`[name="${n}"]`); if (el) el.selectedIndex = 0; });

        // checkbox -> off
        const smoker = form.querySelector('[name="smoker"]');
        if (smoker) smoker.checked = false;

        // pulizia validazione bootstrap
        form.classList.remove('was-validated');
        form.querySelectorAll('.is-valid, .is-invalid').forEach(el => {
          el.classList.remove('is-valid','is-invalid');
        });

        // UI: titolo modale
        const title = modalEl.querySelector('.modal-title');
        if (title) title.textContent = 'Crea profilo';

        // UI: bottoni footer (adatta la versione "update" a "create")
        const submitBtn = modalEl.querySelector('.modal-footer button[type="submit"]');
        if (submitBtn) {
          submitBtn.textContent = 'Salva profilo';
          submitBtn.name = '';         // niente action esplicita → insert
          submitBtn.value = '';
          submitBtn.classList.remove('btn-outline-danger'); // sicurezza
          submitBtn.classList.add('btn-primary');
        }
        // nascondi l’eventuale bottone "Elimina"
        const deleteBtn = modalEl.querySelector('.modal-footer button.btn-outline-danger[name="action"][value="delete"]');
        if (deleteBtn) deleteBtn.style.display = 'none';
      }

      // Click su "Inserisci profilo" → apri modale in modalità "create"
      document.querySelectorAll('[data-bs-target="#site-modal-profile"]').forEach(btn => {
        btn.addEventListener('click', () => {
          resetProfileFormToCreate();
        });
      });

      // Quando il modale viene chiuso → pulisco l’URL da ?profile_id
      modalEl.addEventListener('hidden.bs.modal', () => {
        const url = new URL(window.location.href);
        if (url.searchParams.has('profile_id')) {
          url.searchParams.delete('profile_id');
          window.history.replaceState({}, '', url);
        }
      });

      // Se arrivo con ?profile_id=… mostro subito il modale in modalità "edit"
      {% if to_edit %}
        const myModal = new bootstrap.Modal(modalEl);
        myModal.show();
      {% endif %}
    });
  </script>

<!-- ===========================================================================
     SCRIPT: BIO 5 RIGHE + CONTINUA A LEGGERE, E VALIDAZIONE MODALI
     =========================================================================== -->
<script>
(() => {
  function setupBio(block){
    if (block.dataset.initialized) return;
    block.dataset.initialized = '1';

    const box  = block.querySelector('.bio-textbox');   // wrapper
    const txt  = block.querySelector('.bio-text');      // elemento clamped
    const line = block.querySelector('.read-more-line');
    const dots = line && line.querySelector('.dots');
    const btn  = line && line.querySelector('.read-more');
    if (!box || !txt || !line || !dots || !btn) return;

    // testo già presente nel DOM (preserva \n)
    const full = (txt.textContent || '').trim();
    if (!full){ txt.textContent=''; line.classList.add('d-none'); return; }

    // numero di righe dal data-attribute (default 5)
    const maxLines = Number(block.dataset.lines || 5);
    txt.style.setProperty('--lines', String(maxLines));

    // serve "continua a leggere"?
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        const needMore = txt.scrollHeight > txt.clientHeight + 1;
        if (needMore){
          line.classList.remove('d-none');
          btn.setAttribute('aria-expanded','false');
          btn.textContent = 'Continua a leggere';
          dots.textContent = '...';
        } else {
          line.classList.add('d-none');
        }
      });
    });

    // toggle espansione
    btn.addEventListener('click', () => {
      const expanded = box.classList.toggle('expanded');
      btn.textContent = expanded ? 'Mostra meno' : 'Continua a leggere';
      btn.setAttribute('aria-expanded', expanded ? 'true' : 'false');
      dots.textContent = expanded ? '' : '...';
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.bio-block').forEach(setupBio);
  });
})();
</script>

<!-- ===========================================================================
     SCRIPT VALIDAZIONE CLIENT
     =========================================================================== -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  // ---------- helpers stile bootstrap ----------
  const setNeutral = el => el.classList.remove('is-valid','is-invalid');
  const setValid   = el => { el.classList.add('is-valid'); el.classList.remove('is-invalid'); };
  const setInvalid = (el, msg) => {
    el.classList.add('is-invalid');
    el.classList.remove('is-valid');
    ensureFeedback(el, msg);
  };

  function ensureFeedback(input, msg){
    let fb = input.closest('.col, .mb-3, .form-group')?.querySelector('.invalid-feedback')
           || input.parentElement.querySelector('.invalid-feedback');
    if (!fb) {
      fb = document.createElement('div');
      fb.className = 'invalid-feedback';
      input.parentElement.appendChild(fb);
    }
    if (msg) fb.textContent = msg;
  }

  const toFloat = v => {
    const s = String(v ?? '').trim().replace(',', '.');
    if (!s) return null;
    const n = Number(s);
    return Number.isFinite(n) ? n : NaN;
  };

  function validateField(input, { required=false, test=()=>true, normalize=v=>v, msg='' } = {}, { fromBlur=false } = {}) {
    if (!input) return true;

    const raw = input.value ?? '';
    const val = normalize(raw);

    if (!required && (String(val).trim() === '' || val === null)) {
      setNeutral(input);
      return true;
    }

    const ok = test(val);
    if (ok) setValid(input);
    else {
      if (fromBlur || required || String(val).trim() !== '') setInvalid(input, msg);
      else setNeutral(input);
    }
    return ok;
  }

  // ============================================================
  // Funzione comune: collega blur + input live
  function attachValidation(el, rule) {
    if (!el) return;
    // blur = prima validazione
    el.addEventListener('blur', () => validateField(el, rule, { fromBlur:true }));
    // input = se era invalid, controlla live
    el.addEventListener('input', () => {
      if (el.classList.contains('is-invalid')) {
        validateField(el, rule, { fromBlur:false });
      }
    });
  }

  // ======================================================================
  // 1) MODALI "SCRIVI A …"
  // ======================================================================
  const reEmail = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/;
  const rePhone = /^[0-9\s()+.-]{8,}$/;
  const rePhoneDigits = /^\D*(\d\D*){8,}$/;

  document.querySelectorAll('form.needs-validation[action$="send_message"]').forEach(form => {
    const name    = form.querySelector('[name="sender_name"]');
    const phone   = form.querySelector('[name="sender_phone"]');
    const email   = form.querySelector('[name="sender_email"]');
    const age     = form.querySelector('[name="sender_age"]');
    const city    = form.querySelector('[name="sender_city"]');
    const job     = form.querySelector('[name="sender_job"]');
    const message = form.querySelector('[name="sender_message"]');
    const privacy = form.querySelector('[name="agree_privacy"]');

    const rules = new Map([
      [name,    { required:true,  test:v => String(v).trim().length >= 2,  msg:'Inserisci almeno 2 caratteri.' }],
      [phone,   { required:true,  test:v => rePhone.test(v) && rePhoneDigits.test(v), msg:'Numero non valido: servono almeno 8 cifre.' }],
      [email,   { required:true,  test:v => reEmail.test(v), msg:'Inserisci un’email valida.' }],
      [age,     { required:true,  test:v => Number.isInteger(+v) && +v>=18 && +v<=120, msg:'Età non valida (18–120).' }],
      [city,    { required:true,  test:v => String(v).trim().length >= 2, msg:'Inserisci la tua città.' }],
      [job,     { required:false, test:v => String(v).trim().length >= 2, msg:'Almeno 2 caratteri (oppure lascia vuoto).' }],
      [message, { required:false, test:v => String(v).trim().length >= 5, msg:'Almeno 5 caratteri (oppure lascia vuoto).' }],
    ]);

    rules.forEach((rule, el) => attachValidation(el, rule));

    privacy?.addEventListener('change', () => {
      privacy.checked ? setValid(privacy) : setInvalid(privacy, 'Devi accettare l’informativa privacy.');
    });

    form.addEventListener('submit', (e) => {
      let ok = true;
      rules.forEach((rule, el) => { if (el) ok = validateField(el, rule) && ok; });
      if (privacy && !privacy.checked) { setInvalid(privacy, 'Devi accettare l’informativa privacy.'); ok = false; }
      form.classList.add('was-validated');
      if (!ok) { e.preventDefault(); e.stopPropagation(); (form.querySelector('.is-invalid') || name)?.focus(); }
    });

    form.closest('.modal')?.addEventListener('show.bs.modal', () => {
      form.classList.remove('was-validated');
      form.querySelectorAll('.is-valid, .is-invalid').forEach(setNeutral);
    });
  });

  // ======================================================================
  // 2) MODALE "CREA / MODIFICA PROFILO"
  // ======================================================================
  const profileForm = document.querySelector('#site-modal-profile form');
  if (profileForm) {
    const first_name = profileForm.querySelector('[name="first_name"]');
    const gender     = profileForm.querySelector('[name="gender"]');
    const bio        = profileForm.querySelector('[name="bio"]');
    const birth_year = profileForm.querySelector('[name="birth_year"]');
    const city       = profileForm.querySelector('[name="city"]');
    const occupation = profileForm.querySelector('[name="occupation"]');
    const last_name  = profileForm.querySelector('[name="last_name"]');
    const eyes_color = profileForm.querySelector('[name="eyes_color"]');
    const hair_color = profileForm.querySelector('[name="hair_color"]');
    const marital    = profileForm.querySelector('[name="marital_status"]');
    const weight_kg  = profileForm.querySelector('[name="weight_kg"]');
    const height_m   = profileForm.querySelector('[name="height_m"]');

    const rulesP = new Map([
      [first_name,{ required:true,  test:v => String(v).trim().length >= 2, msg:'Inserisci almeno 2 caratteri.' }],
      [gender,    { required:true,  test:v => String(v).trim() !== '',      msg:'Seleziona il genere.' }],
      [bio,       { required:true,  test:v => String(v).trim().length >= 10,msg:'Inserisci almeno 10 caratteri.' }],
      [birth_year,{
  required:false,
  test:v => {
    if (String(v).trim()==='') return true;   // vuoto → neutro
    if (!/^\d{4}$/.test(v)) return false;     // deve avere 4 cifre
    const n = Number(v);
    return n >= 1900 && n <= 2100;           // deve stare nel range
  },
  msg:'Inserisci un anno tra 1900 e 2100.'
}],
      [city,      { required:false, test:v => String(v).trim().length >= 2, msg:'Almeno 2 caratteri (oppure lascia vuoto).' }],
      [occupation,{ required:false, test:v => String(v).trim().length >= 2, msg:'Almeno 2 caratteri (oppure lascia vuoto).' }],
      [last_name, { required:false, test:v => String(v).trim().length >= 2, msg:'Almeno 2 caratteri (oppure lascia vuoto).' }],
      [eyes_color,{ required:false, test:v => String(v).trim() !== '',      msg:'Seleziona un valore (oppure lascia vuoto).' }],
      [hair_color,{ required:false, test:v => String(v).trim() !== '',      msg:'Seleziona un valore (oppure lascia vuoto).' }],
      [marital,   { required:false, test:v => String(v).trim() !== '',      msg:'Seleziona un valore (oppure lascia vuoto).' }],
      [weight_kg, { required:false, test:v => {
        if (String(v).trim()==='') return true;
        const n = Number(v); return Number.isInteger(n) && n>=30 && n<=300;
      }, msg:'Peso non valido (30–300 kg).'}],
      [height_m,  { required:false, test:v => {
        if (v === null || String(v).trim()==='') return true;
        const n = toFloat(v); return !Number.isNaN(n) && n>=1.00 && n<=2.50;
      }, normalize:s => String(s ?? '').trim().replace(',', '.'), msg:'Altezza non valida (1.00–2.50 m).'}],
    ]);

    rulesP.forEach((rule, el) => attachValidation(el, rule));

    profileForm.addEventListener('submit', (e) => {
      let ok = true;
      rulesP.forEach((rule, el) => { if (el) ok = validateField(el, rule) && ok; });
      if (height_m && height_m.value) height_m.value = height_m.value.replace(',', '.');
      profileForm.classList.add('was-validated');
      if (!ok) { e.preventDefault(); e.stopPropagation(); (profileForm.querySelector('.is-invalid') || first_name)?.focus(); }
    });

    document.getElementById('site-modal-profile')?.addEventListener('show.bs.modal', () => {
      profileForm.classList.remove('was-validated');
      profileForm.querySelectorAll('.is-valid, .is-invalid').forEach(setNeutral);
    });
  }
});
</script>

{% endblock %}
